name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (branch/tag/commit SHA)'
        required: false
        type: string

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      CI: true
      INTEG_TEST_AUTH_URL: https://main-id.getbodhi.app
      INTEG_TEST_AUTH_REALM: bodhi
      INTEG_TEST_CLIENT_ID: resource-17e8a0e7-89c4-415d-832d-446b3be6fe77
      INTEG_TEST_CLIENT_SECRET: ${{ secrets.INTEG_TEST_CLIENT_SECRET }}
      INTEG_TEST_USERNAME: ${{ secrets.INTEG_TEST_USERNAME }}
      INTEG_TEST_PASSWORD: ${{ secrets.INTEG_TEST_PASSWORD }}
      VITE_BODHI_APP_CLIENT_ID: ${{ secrets.VITE_BODHI_APP_CLIENT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.ref || '' }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Typecheck
        run: npm run typecheck

      - name: Unit tests
        run: npm run test

      - name: Setup Virtual Display (Linux)
        run: |
          export DISPLAY=:99
          Xvfb :99 -ac -screen 0 1920x1080x24 > /dev/null 2>&1 &
          sleep 3
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-1.57.0

      - name: Install Playwright
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium

      - name: Set HF_HOME environment variable
        run: |
          echo "HF_HOME=${HOME}/.cache/huggingface" >> $GITHUB_ENV
          echo "Set HF_HOME to: ${HOME}/.cache/huggingface"

      - name: Cache HuggingFace models
        uses: actions/cache@v5
        id: cache-hf
        with:
          path: ${{ env.HF_HOME }}
          key: hf-cache-${{ runner.os }}-gemma3-1b-it
          restore-keys: |
            hf-cache-${{ runner.os }}-

      - name: Setup Python and download model
        if: steps.cache-hf.outputs.cache-hit != 'true'
        run: |
          python -m pip install -U pip huggingface_hub
          python -c "from huggingface_hub import hf_hub_download; hf_hub_download('bartowski/google_gemma-3-1b-it-GGUF', 'google_gemma-3-1b-it-Q4_K_M.gguf', revision='116f76234503685a98f572982177b11d44ec8ff1')"
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}

      - name: E2E tests
        run: |
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24 -ac' npm run ci:test:e2e

      - name: Upload playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 7

      - name: Test summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "✅ Lint: Passed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Build: Passed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Typecheck: Passed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Unit Tests: Passed" >> $GITHUB_STEP_SUMMARY
          echo "✅ E2E Tests: Passed" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Deploy
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: peter-evans/repository-dispatch@v3
        with:
          event-type: deploy-pages
          client-payload: '{"sha": "${{ github.sha }}"}'
